<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurador de Zonas - ParkingEyes</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 20px; }
        .container { display: flex; gap: 20px; }
        .canvas-container { position: relative; }
        canvas { border: 2px solid #333; cursor: crosshair; background: #000; }
        .controls { width: 300px; background: #2a2a2a; padding: 20px; border-radius: 8px; }
        h1 { margin-top: 0; font-size: 1.5rem; color: #007bff; }
        .btn { display: block; width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .zone-list { max-height: 400px; overflow-y: auto; margin-top: 20px; }
        .zone-item { background: #333; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .instructions { font-size: 0.9rem; color: #aaa; margin-bottom: 20px; }
        select { width: 100%; padding: 10px; margin-bottom: 20px; background: #333; color: white; border: 1px solid #444; }
    </style>
</head>
<body>

    <h1>üìê ParkingEyes - Configurador de Zonas</h1>

    <div class="container">
        <div class="canvas-container">
            <div style="margin-bottom: 15px;">
                <label>Seleccionar C√°mara para configurar:</label>
                <select id="cameraSelect" onchange="changeCamera()">
                    <option value="cam-01">Cargando c√°maras...</option>
                </select>
            </div>
            <canvas id="parkingCanvas" width="1020" height="500"></canvas>
        </div>

        <div class="controls">
            <p class="instructions">
                <b>Instrucciones:</b><br>
                1. Selecciona la c√°mara.<br>
                2. Haz 4 clics para marcar un espacio.<br>
                3. Repite para cada parqueadero.<br>
                4. ¬°No olvides Guardar!
            </p>

            <button class="btn btn-danger" onclick="clearLastPoint()">Deshacer √∫ltimo punto</button>
            <button class="btn btn-danger" onclick="deleteAllZones()">Borrar todas las zonas</button>
            <hr>
            <button class="btn btn-success" onclick="saveConfiguration()">üíæ GUARDAR ZONAS</button>

            <h3>Zonas (<span id="zoneCount">0</span>)</h3>
            <div class="zone-list" id="zoneList"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('parkingCanvas');
        const ctx = canvas.getContext('2d');
        const zoneListEl = document.getElementById('zoneList');
        const zoneCountEl = document.getElementById('zoneCount');
        const cameraSelect = document.getElementById('cameraSelect');

        let zones = [];
        let currentPoints = [];
        let backgroundImage = new Image();
        let currentCameraId = 'cam-01';
        let streamImage = new Image(); // Imagen para el stream
        let isStreamLoaded = false;

        async function changeCamera() {
            currentCameraId = cameraSelect.value;
            currentPoints = [];
            await loadSavedZones();
            startStream();
        }

        async function loadSavedZones() {
            try {
                const response = await fetch(`/api/zones/get?cameraId=${currentCameraId}`);
                const data = await response.json();
                if (data.success) {
                    zones = data.zones;
                    updateZoneList();
                }
            } catch (e) {
                console.error("Error cargando zonas:", e);
            }
        }

        function startStream() {
            // Usar el stream RAW (sin IA) para m√°xima velocidad
            streamImage.src = `/api/video/feed?cameraId=${currentCameraId}&raw=true&t=` + new Date().getTime();
            streamImage.onload = () => {
                isStreamLoaded = true;
            };
        }

        function gameLoop() {
            // Dibujado continuo (60fps si es posible)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 1. Dibujar Video de fondo
            if (streamImage.complete && streamImage.naturalWidth > 0) {
                ctx.drawImage(streamImage, 0, 0, canvas.width, canvas.height);
            } else if (backgroundImage.src) {
                // Fallback a imagen est√°tica si existe
                ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
            }
            
            // 2. Dibujar Zonas (Pol√≠gonos)
            zones.forEach(zone => {
                ctx.beginPath();
                ctx.moveTo(zone.coordinates[0].x, zone.coordinates[0].y);
                zone.coordinates.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.closePath();
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.fillText(zone.spaceNumber, zone.coordinates[0].x, zone.coordinates[0].y - 5);
            });

            // 3. Dibujar puntos actuales (si estoy dibujando)
            if (currentPoints.length > 0) {
                ctx.beginPath();
                ctx.moveTo(currentPoints[0].x, currentPoints[0].y);
                currentPoints.forEach(p => ctx.lineTo(p.x, p.y));
                ctx.strokeStyle = 'yellow';
                ctx.stroke();
                currentPoints.forEach(p => {
                    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fillStyle = 'yellow'; ctx.fill();
                });
            }
            
            requestAnimationFrame(gameLoop);
        }

        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = Math.round(e.clientX - rect.left);
            const y = Math.round(e.clientY - rect.top);
            currentPoints.push({x, y});
            if (currentPoints.length === 4) {
                addZone(currentPoints);
                currentPoints = [];
            }
        });

        function addZone(points) {
            const id = zones.length + 1;
            zones.push({
                id: `zone-${currentCameraId}-${Date.now()}`,
                spaceNumber: id,
                coordinates: [...points]
            });
            updateZoneList();
            saveConfiguration(true); // Auto-save silent
        }

        function updateZoneList() {
            zoneListEl.innerHTML = '';
            zones.forEach((zone, index) => {
                const div = document.createElement('div');
                div.className = 'zone-item';
                div.innerHTML = `<span>üÖøÔ∏è Espacio ${zone.spaceNumber}</span><button style="background:none;border:none;color:red;cursor:pointer" onclick="deleteZone(${index})">‚ùå</button>`;
                zoneListEl.appendChild(div);
            });
            zoneCountEl.innerText = zones.length;
        }

        function deleteZone(index) {
            zones.splice(index, 1);
            zones.forEach((z, i) => z.spaceNumber = i + 1);
            updateZoneList();
            saveConfiguration(true); // Auto-save silent
        }

        function deleteAllZones() {
            if(confirm("¬øBorrar todo?")) { 
                zones = []; 
                currentPoints = []; 
                updateZoneList(); 
                saveConfiguration(true); // Auto-save silent
            }
        }

        function clearLastPoint() { currentPoints.pop(); }

        async function saveConfiguration(silent = false) {
            // Permitir guardar 0 zonas (para borrar todo)
            try {
                const response = await fetch('/api/zones/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cameraId: currentCameraId, zones: zones })
                });
                const res = await response.json();
                if (res.success && !silent) alert("‚úÖ Zonas guardadas para " + currentCameraId);
            } catch (e) { if(!silent) alert("‚ùå Error: " + e); }
        }

        // NO NECESITAMOS draw() separado, todo est√° en gameLoop
        
        async function loadCameras() {
            try {
                const response = await fetch('/api/cameras/list');
                const data = await response.json();
                if (data.success) {
                    cameraSelect.innerHTML = '';
                    data.cameras.forEach(cam => {
                        const option = document.createElement('option');
                        option.value = cam.id;
                        option.text = `${cam.id}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    // Seleccionar cam-01 por defecto si existe
                    if (data.cameras.some(c => c.id === 'cam-01')) {
                        cameraSelect.value = 'cam-01';
                    } else if (data.cameras.length > 0) {
                        cameraSelect.value = data.cameras[0].id;
                    }
                    currentCameraId = cameraSelect.value;
                }
            } catch (e) {
                console.error("Error loading cameras:", e);
            }
        }

        async function init() {
            await loadCameras();
            await loadSavedZones();
            startStream(); // Iniciar stream en lugar de snapshot est√°tico
            requestAnimationFrame(gameLoop); // Iniciar loop de renderizado
        }

        init();
        // setInterval(loadCameraImage, 500); // ELIMINADO
    </script>
</body>
</html>
